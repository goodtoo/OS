# 第五阶段项目说明

## 一、项目目标

第五阶段的目标是构建一个具备 **内存管理能力** 的最小操作系统内核，并进一步提升系统的稳定性和可扩展性。

核心目标：

- 固定内核入口，保证内核加载与跳转稳定
- 在保护模式下初始化 **GDT / IDT**
- 构建 **中断服务框架 (ISR/IRQ)**，支持异常、定时器、键盘中断
- 实现基于 **BIOS E820** 的物理内存检测
- 设计 **位图内存分配器 (PMM)**，支持页级分配与释放
- 提升内核健壮性（避免 Triple Fault，统一异常处理）

------

## 二、系统结构

### 1. Bootloader (`boot/boot.asm`)

- BIOS 启动后执行，加载内核至 `0x1000`
- 关闭 **NMI**，开启 **A20 地址线**，建立 **GDT**
- 使用 BIOS 中断 `int 13h` 从软盘扇区读取内核
- 进入保护模式后跳转固定入口 `kernel_entry`
- 启动时屏幕依次显示：
  - `A`：进入 bootloader
  - `C`：内核加载成功
  - `PJ`：进入保护模式，准备跳转内核

### 2. 内核 (`kernel/`)

- **start.asm**
  - 定义固定入口 `kernel_entry`，保证加载稳定
  - 进入内核后显示标记 `ENT` 并调用 `kernel_main`
- **kernel.c**
  - 内核主入口 `kernel_main`
  - 安装 **兜底 IDT**（避免保护模式初期异常）
  - 重新开启 NMI
  - 初始化物理内存管理器（PMM）并打印空闲页数
  - 调用 `idt_init`、`pic_remap`、`pit_init`
  - 打印启动信息 `"Stage 3: IDT+PIC+PIT+PMM"`
- **idt.c**
  - 设置 IDT 表，初始化中断向量
  - 配置 **PIT (IRQ0)** 定时中断
  - 配置 **键盘 (IRQ1)** 中断
  - ISR 框架统一调用 `isr_handler` 进行处理
- **isr.asm**
  - 汇编实现 ISR 入口，保存/恢复寄存器现场
  - 调用 C 层 `isr_handler`
  - `IRQ0`：打印 `*`（定时器心跳）
  - `IRQ1`：打印 `#`（键盘输入）
  - 其他异常：打印 `E`
- **pmm.c / pmm.h**
  - 使用 BIOS **E820 内存映射** 获取物理内存布局
  - 设计基于 **位图** 的页级分配器
  - 提供 `kmalloc_page()` / `kfree_page()` 接口
- **kernel.ld**
  - 链接脚本，指定内核从物理地址 `0x1000` 开始
  - 保证 `.text.start` 段最先放置（内核入口固定）

------

## 三、构建流程

### 目录结构

```
stage5/
├── boot/
│   └── boot.asm          # Bootloader
├── kernel/
│   ├── start.asm         # 固定入口 kernel_entry
│   ├── kernel.c          # 内核主入口
│   ├── idt.c             # IDT + PIC + PIT
│   ├── isr.asm           # ISR 汇编实现
│   ├── pmm.c / pmm.h     # 物理内存管理
├── kernel.ld             # 链接脚本
├── Makefile              # 构建脚本
```

### 编译与运行

```
make clean && make       # 构建
make run                 # QEMU 运行 (-fda 模式)
```

------

## 四、运行效果

1. 启动顺序
   - `A`：进入 bootloader
   - `C`：内核加载成功
   - `PJ`：进入保护模式
   - 内核入口执行成功：显示 `"OK1 Stage 3: IDT+PIC+PIT+PMM"`
2. 内核输出
   - 第二行显示 `"PMM free pages: ..."`, 打印空闲页框数量
   - 第三行及后续：持续输出 `*`（定时器中断）
   - 按键输入：输出 `#`（键盘中断）

![image-20250918125138875](D:\searcher\OS-main\stage5\image-20250918125138875.png)

> 实际运行截图显示内核能够稳定运行，并持续响应 **IRQ0 + IRQ1**。

------

## 五、技术要点

- **固定入口机制**
  - 使用 `.text.start` 段和 `kernel_entry`，保证内核入口始终在 `0x1000`
- **保护模式切换**
  - Boot 阶段设置 CR0.PE=1，使用 GDT 段选择子进入 32 位模式
- **兜底 IDT**
  - 保护模式早期安装临时 IDT，避免异常导致 triple fault
- **PIC 重映射**
  - IRQ0~IRQ15 重映射到 `0x20`~`0x2F`，避免与 CPU 异常冲突
- **PIT 定时器**
  - 通过端口 `0x43/0x40` 配置时钟周期，触发周期性中断
- **PMM 位图内存管理**
  - 使用 BIOS E820 内存表初始化位图
  - 低端 1MB、内核占用区域标记为已用，其余页框可分配
- **NMI 控制**
  - Boot 阶段屏蔽 NMI → 内核初始化后重新开启

------

## 六、阶段总结

第五阶段的成果是一个具备 **内存管理能力与完整中断框架** 的最小保护模式内核：

- Bootloader 能稳定加载内核并进入保护模式
- 内核入口固定，避免跳转不确定性
- IDT/PIC/PIT/键盘中断配置成功
- 定时器中断持续触发 `*`，键盘输入触发 `#`
- PMM 位图分配器能够正确统计、分配和释放页框
- 系统健壮性显著提升（不再 triple fault）