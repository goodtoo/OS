# 第四阶段项目说明

## 一、项目目标

在前三阶段的基础上，第四阶段的目标是构建一个能够运行在 **x86 保护模式** 下的最小操作系统内核，支持 **定时器中断 (IRQ0)** 和 **键盘中断 (IRQ1)**，并通过屏幕输出验证中断是否正常触发。

核心目标：

- 在保护模式下运行 C 内核
- 配置 **GDT / IDT**
- 重映射并初始化 **8259A PIC**
- 设置 **PIT 定时器**，定期触发中断输出 `*`
- 设置 **键盘中断**，按键输入时输出 `#`

------

## 二、系统结构

### 1. Bootloader (`boot/boot.asm`)

- 负责 BIOS 加载 → 内核加载 → 保护模式切换
- 初始化 **A20 地址线**，建立 **GDT**
- 使用 BIOS 中断 `int 13h` 从软盘扇区加载内核至 `0x1000`
- 进入保护模式后跳转内核入口 (`kernel_main`)
- 启动时屏幕依次显示：
   `A` → `C` → `S/Z` → `P` → `J` → `K`
  - `A`：进入 bootloader
  - `C`：加载内核成功
  - `S/Z`：检查内核首字节 (`55`=OK 显示 `S`，否则 `Z`)
  - `P`：进入保护模式
  - `J`：准备跳入内核
  - `K`：内核入口执行成功

### 2. 内核 (`kernel/`)

- **kernel.c**
  - 内核入口 `kernel_main`
  - 显示启动信息 `"Stage 4: Timer + IRQ ready"`
  - 无限循环等待中断
- **idt.c**
  - 初始化 IDT
  - 设置 ISR（异常/中断处理程序）
  - 配置 **PIT (8253/8254)** 周期性定时中断
- **isr.asm**
  - 汇编实现低级 ISR 封装
  - 定时器 ISR 打印 `*`
  - 键盘 ISR 打印 `#`
  - 异常 ISR（如除零错误）打印红底白字 `E`
- **kernel.ld**
  - 内核链接脚本，指定内核从物理地址 `0x1000` 开始加载

------

## 三、构建流程

### 目录结构

```
stage4/
├── boot/
│   └── boot.asm          # Bootloader
├── kernel/
│   ├── kernel.c          # C 内核入口
│   ├── idt.c             # IDT + PIC + PIT 初始化
│   ├── isr.asm           # ISR 汇编实现
│   └── ...
├── kernel.ld             # 链接脚本
├── Makefile              # 构建脚本
```

### 编译与运行

```bash
make clean && make       # 构建
make run                 # QEMU 运行 (-fda 模式)
```

------

## 四、运行效果

1. 启动顺序
   - `A C S P J K` 依次出现，确认 bootloader 到内核加载流程正确
2. 内核输出
   - 第一行：`Stage 4: Timer + IRQ ready`
   - 第二行开始：`*` 持续闪烁（定时器中断）
   - 按下键盘：屏幕输出 `#`（键盘中断）

> 这表明 **定时器 + 键盘中断** 工作正常，IDT/PIC/PIT 配置成功。
>
> ![image-20250917111852267](C:\Users\Jump\Desktop\stage4\image-20250917111852267.png)

------

## 五、技术要点

- **保护模式切换**：设置 CR0.PE=1，使用 GDT 段选择子
- **IDT 初始化**：256 项表格，每项 8 字节，使用 `lidt` 加载
- **PIC 重映射**：IRQ0~IRQ15 映射到 `0x20`~`0x2F`，避免与 CPU 异常冲突
- **PIT 定时器**：通过端口 `0x43/0x40` 设置时钟周期
- **键盘控制器**：通过端口 `0x60` 读取扫描码
- **中断返回**：ISR 用 `iret` 恢复现场

------

## 六、阶段总结

第四阶段的成果是一个能处理中断的最小保护模式内核：

- Bootloader 能正确加载内核并切换模式
- 内核能初始化 GDT、IDT、PIC
- 定时器中断触发正常 (`*`)
- 键盘中断触发正常 (`#`)

这为下一阶段（内存管理、多任务调度、系统调用等）奠定了坚实的基础。

